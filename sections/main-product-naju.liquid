{% if product.template_suffix == 'capinha-personalizada' %}
  {% assign is_custom_case = true %}
{% else %}
  {% assign is_custom_case = false %}
{% endif %}

<section class="naju-pdp">
  <div class="container naju-pdp__grid">
    <!-- GALERIA -->
    <div class="naju-pdp__media">
      <div class="naju-card naju-media">
        <div class="naju-media__stage">
          {% assign first_image = product.featured_image | default: product.images.first %}
          {% if first_image %}
            <img
              class="naju-media__main"
              src="{{ first_image | image_url: width: 1600 }}"
              alt="{{ product.title | escape }}"
              loading="eager"
            >
          {% endif %}
        </div>

        {% if product.images.size > 1 %}
          <div class="naju-media__thumbs" role="list" aria-label="Miniaturas do produto">
            {% for img in product.images %}
              <button
                type="button"
                class="naju-thumb"
                data-full="{{ img | image_url: width: 1600 }}"
                data-alt="{{ product.title | escape }}"
                aria-label="Ver imagem {{ forloop.index }}"
              >
                <img src="{{ img | image_url: width: 220 }}" alt="" loading="lazy">
              </button>
            {% endfor %}
          </div>
        {% endif %}
      </div>

      <div class="naju-pinfo">
        <div class="naju-pinfo__top">
          <div class="naju-pinfo__title">Entrega e suporte</div>
          <div class="naju-pinfo__badges">
            <span class="naju-chip">Garantia</span>
            <span class="naju-chip">Nota fiscal</span>
            <span class="naju-chip">Suporte</span>
          </div>
        </div>

        <div class="naju-pinfo__cep">
          <label class="naju-label" for="naju-cep">Calcular frete</label>
          <div class="naju-ceprow">
            <input id="naju-cep" class="naju-input" inputmode="numeric" placeholder="Digite seu CEP" maxlength="9">
            <button class="naju-btn naju-btn--ghost" type="button" id="naju-cep-btn">Consultar</button>
          </div>
        </div>

        <!--
          <div class="naju-accordion">
            <details open>
              <summary>Garantia</summary>
              <div class="naju-accordion__content">
                {% if product.metafields.custom.garantia != blank %}
                  {{ product.metafields.custom.garantia | metafield_tag }}
                {% else %}
                  Garantia conforme o produto. Em caso de dúvidas, fale com a loja.
                {% endif %}
              </div>
            </details>

            <details>
              <summary>Entrega</summary>
              <div class="naju-accordion__content">
                {% if product.metafields.custom.entrega != blank %}
                  {{ product.metafields.custom.entrega | metafield_tag }}
                {% else %}
                  Prazos e valores são calculados no checkout.
                {% endif %}
              </div>
            </details>

            <details>
              <summary>Trocas e devoluções</summary>
              <div class="naju-accordion__content">
                {% if shop.refund_policy != blank %}
                  {{ shop.refund_policy.body }}
                {% else %}
                  Consulte nossa política de trocas e devoluções.
                {% endif %}
              </div>
            </details>
          </div>
        -->
      </div>
    </div>

    <!-- INFO / COMPRA -->
    <div class="naju-pdp__info">
      <div class="naju-card naju-info">
        <div class="naju-info__top">
          <h1 class="naju-info__title">{{ product.title }}</h1>

          {% if product.vendor != blank or product.type != blank %}
            <div class="naju-info__meta">
              {% if product.vendor != blank -%}
                <span>{{ product.vendor }}</span>
              {%- endif %}
              {% if product.vendor != blank and product.type != blank %}<span class="naju-meta__dot"></span>{% endif %}
              {% if product.type != blank -%}
                <span>{{ product.type }}</span>
              {%- endif %}
            </div>
          {% endif %}
        </div>

        <div class="naju-price" data-price>
          {{ product.selected_or_first_available_variant.price | money }}
          {% if product.selected_or_first_available_variant.compare_at_price
              > product.selected_or_first_available_variant.price
          %}
            <span class="naju-price__compare">
              {{ product.selected_or_first_available_variant.compare_at_price | money }}
            </span>
          {% endif %}
        </div>

        {% form 'product', product, class: 'naju-buy', novalidate: 'novalidate', enctype: 'multipart/form-data' %}
          <input type="hidden" name="id" value="{{ product.selected_or_first_available_variant.id }}" data-variant-id>

          {% unless product.has_only_default_variant %}
            <div class="naju-opts">
              {% for option in product.options_with_values %}
                <div class="naju-opt">
                  <label class="naju-opt__label">{{ option.name }}</label>
                  <select class="naju-select" data-option-index="{{ forloop.index0 }}">
                    {% for value in option.values %}
                      <option
                        value="{{ value | escape }}"
                        {% if option.selected_value == value %}
                          selected
                        {% endif %}
                      >
                        {{ value }}
                      </option>
                    {% endfor %}
                  </select>
                </div>
              {% endfor %}
            </div>
          {% endunless %}

          {% if is_custom_case %}
            <div class="naju-custom">
              <div class="naju-custom__head">
                <div class="naju-custom__title">Personalize sua capinha</div>
                <div class="naju-custom__sub">Envie a arte e informe os detalhes do pedido.</div>
              </div>

              <div class="naju-custom__grid">
                <label class="naju-up" for="naju-art-file">
                  <span class="naju-up__label">1) Envie sua imagem (PNG/JPG)</span>
                  <span class="naju-up__box" id="naju-art-box">
                    <span class="naju-up__hint">Clique para selecionar</span>
                    <img id="naju-art-preview" class="naju-up__preview" alt="" style="display:none;">
                  </span>
                  <input
                    id="naju-art-file"
                    class="naju-up__input"
                    type="file"
                    accept="image/png,image/jpeg"
                    name="properties[Arte enviada]"
                    required
                  >
                </label>

                <div class="naju-custom__fields">
                  <div class="naju-field">
                    <label class="naju-label" for="naju-msg">2) Texto (opcional)</label>
                    <input
                      id="naju-msg"
                      class="naju-input"
                      type="text"
                      name="properties[Texto na capinha]"
                      placeholder="Ex: Nome, frase curta..."
                    >
                  </div>

                  <div class="naju-field">
                    <label class="naju-label" for="naju-notes">3) Observações (opcional)</label>
                    <textarea
                      id="naju-notes"
                      class="naju-textarea"
                      rows="4"
                      name="properties[Observações]"
                      placeholder="Ex: Quero centralizar, sem borda, manter cores..."
                    ></textarea>
                  </div>

                  <label class="naju-check">
                    <input
                      id="naju-confirm"
                      type="checkbox"
                      name="properties[Confirmo que tenho direitos de uso]"
                      value="Sim"
                      required
                    >
                    <span>Confirmo que tenho autorização para usar essa imagem.</span>
                  </label>

                  <div id="naju-custom-err" class="naju-custom__err" style="display:none;">
                    Envie a imagem e marque a confirmação para continuar.
                  </div>
                </div>
              </div>
            </div>
          {% endif %}

          <div class="naju-buyrow">
            <div class="naju-qty" aria-label="Quantidade">
              <button type="button" class="naju-qty__btn" data-qty-minus aria-label="Diminuir">−</button>
              <input
                class="naju-qty__input"
                name="quantity"
                value="1"
                inputmode="numeric"
                pattern="[0-9]*"
                aria-label="Quantidade"
              >
              <button type="button" class="naju-qty__btn" data-qty-plus aria-label="Aumentar">+</button>
            </div>

            <button class="naju-cta" type="submit" id="naju-add-to-cart">Adicionar ao carrinho</button>
          </div>

          <div class="naju-mini">
            <div class="naju-mini__pill">Entrega rápida</div>
            <div class="naju-mini__pill">Garantia</div>
            <div class="naju-mini__pill">Atendimento real</div>
          </div>
        {% endform %}

        <!-- BLOCOS (Accordion) -->
        <div class="naju-acc">
          <details class="naju-acc__item" open>
            <summary class="naju-acc__sum">Descrição</summary>
            <div class="naju-acc__body">
              {% if product.description != blank %}
                <div class="naju-richtext">{{ product.description }}</div>
              {% else %}
                <p class="naju-muted">Descrição não informada.</p>
              {% endif %}
            </div>
          </details>

          {% assign specs = product.metafields.custom.specs %}
          {% if specs != blank %}
            <details class="naju-acc__item">
              <summary class="naju-acc__sum">Especificações</summary>
              <div class="naju-acc__body">
                <div class="naju-richtext">{{ specs }}</div>
              </div>
            </details>
          {% endif %}

          {% assign shipping = product.metafields.custom.shipping_info %}
          {% if shipping != blank %}
            <details class="naju-acc__item">
              <summary class="naju-acc__sum">Entrega e devolução</summary>
              <div class="naju-acc__body">
                <div class="naju-richtext">{{ shipping }}</div>
              </div>
            </details>
          {% endif %}
        </div>
      </div>
    </div>
  </div>
</section>

<script>
  (function () {
    // ===== Galeria
    const root = document.querySelector('.naju-pdp');
    if (!root) return;

    const mainImg = root.querySelector('.naju-media__main');
    const thumbs = root.querySelectorAll('.naju-thumb');

    if (mainImg && thumbs.length) {
      thumbs[0].classList.add('is-active');

      thumbs.forEach((btn) => {
        btn.addEventListener('click', () => {
          const full = btn.getAttribute('data-full');
          if (!full) return;

          thumbs.forEach(b => b.classList.remove('is-active'));
          btn.classList.add('is-active');

          mainImg.style.opacity = '0.2';
          const tmp = new Image();
          tmp.onload = () => {
            mainImg.src = full;
            mainImg.style.opacity = '1';
          };
          tmp.src = full;
        });
      });
    }

    // ===== Qty
    const qtyInput = root.querySelector('.naju-qty__input');
    const minus = root.querySelector('[data-qty-minus]');
    const plus  = root.querySelector('[data-qty-plus]');

    if (qtyInput && minus && plus) {
      const clamp = (v) => Math.max(1, isNaN(v) ? 1 : v);
      const getV = () => clamp(parseInt(qtyInput.value || '1', 10));

      minus.addEventListener('click', () => qtyInput.value = clamp(getV() - 1));
      plus.addEventListener('click',  () => qtyInput.value = clamp(getV() + 1));

      qtyInput.addEventListener('input', () => {
        qtyInput.value = (qtyInput.value || '').replace(/[^\d]/g, '');
        if (qtyInput.value === '') qtyInput.value = '1';
      });
      qtyInput.addEventListener('blur', () => qtyInput.value = String(getV()));
    }

    // ===== Variants (atualiza variant id + preço)
    const variantData = {{ product.variants | json }};
    const optionSelects = root.querySelectorAll('.naju-select');
    const variantIdInput = root.querySelector('[data-variant-id]');
    const priceEl = root.querySelector('[data-price]');

    function formatMoney(cents) {
      const amount = (cents / 100).toFixed(2).replace('.', ',');
      return 'R$ ' + amount;
    }

    function findVariant() {
      if (!optionSelects.length) return variantData.find(v => v.available) || variantData[0];
      const selected = Array.from(optionSelects).map(s => s.value);
      return variantData.find(v => selected.every((val, idx) => v.options[idx] === val)) || variantData[0];
    }

    function syncVariant() {
      const v = findVariant();
      if (!v) return;

      if (variantIdInput) variantIdInput.value = v.id;
      if (priceEl) priceEl.textContent = formatMoney(v.price);
    }

    optionSelects.forEach(s => s.addEventListener('change', syncVariant));
    syncVariant();
  })();

  (function () {
    const input = document.getElementById('naju-cep');
    const btn = document.getElementById('naju-cep-btn');
    const hint = document.getElementById('naju-cep-hint');
    if (!input || !btn || !hint) return;

    const mask = (v) => (v || '').replace(/\D/g,'').slice(0,8).replace(/^(\d{5})(\d{0,3})$/, (_,a,b)=> b?`${a}-${b}`:a);

    const saved = localStorage.getItem('naju_cep');
    if (saved) input.value = mask(saved);

    input.addEventListener('input', () => input.value = mask(input.value));
    btn.addEventListener('click', () => {
      const cep = (input.value || '').replace(/\D/g,'');
      if (cep.length !== 8) { hint.textContent = 'CEP inválido. Use 8 dígitos.'; return; }
      localStorage.setItem('naju_cep', cep);
      hint.textContent = `CEP salvo (${mask(cep)}). O frete será calculado no checkout.`;
    });
  })();

  (function () {
    const root = document.querySelector('.naju-pdp');
    if (!root) return;

    const isCustom = {{ product.template_suffix | json }} === 'capinha-personalizada';
    if (!isCustom) return;

    const file = document.getElementById('naju-art-file');
    const preview = document.getElementById('naju-art-preview');
    const box = document.getElementById('naju-art-box');
    const confirm = document.getElementById('naju-confirm');
    const btn = document.getElementById('naju-add-to-cart');
    const err = document.getElementById('naju-custom-err');

    function sync() {
      const okFile = file && file.files && file.files.length > 0;
      const okConfirm = confirm && confirm.checked;

      if (btn) btn.disabled = !(okFile && okConfirm);

      if (err) {
        err.style.display = (okFile && okConfirm) ? 'none' : 'block';
      }
    }

    if (btn) btn.disabled = true;

    if (file) {
      file.addEventListener('change', () => {
        const f = file.files && file.files[0];
        if (!f) { sync(); return; }

        const url = URL.createObjectURL(f);
        if (preview) {
          preview.src = url;
          preview.style.display = 'block';
        }
        if (box) box.classList.add('has-file');
        sync();
      });
    }

    if (confirm) confirm.addEventListener('change', sync);

    // Primeira validação
    sync();
  })();
</script>

{% schema %}
{
  "name": "Naju - Produto (PDP)",
  "settings": [],
  "presets": [{ "name": "Naju - Produto (PDP)" }]
}
{% endschema %}
